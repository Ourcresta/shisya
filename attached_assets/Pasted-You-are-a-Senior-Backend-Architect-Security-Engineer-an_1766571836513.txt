You are a Senior Backend Architect, Security Engineer,
and SaaS Platform Developer.

Context:
We are building SHISHYA, the Student Portal backend for the OURSHIKSHA platform.

There are TWO systems:
1) GURU (Admin Portal + APIs) ‚Üí SINGLE SOURCE OF TRUTH
2) SHISHYA (Student Portal Backend) ‚Üí EXECUTION & USER CONTEXT LAYER

NON-NEGOTIABLE RULES:
‚ùó SHISHYA does NOT own pricing, plans, rules, or content definitions
‚ùó SHISHYA only CONSUMES rules and content from GURU
‚ùó SHISHYA owns user sessions, progress, credits usage, and execution flows
‚ùó All writes must respect rules received from GURU

-------------------------------------------------
GOAL
-------------------------------------------------
Generate the COMPLETE BACKEND API for SHISHYA,
covering authentication, learning execution,
wallet & payments, AI tutor, notifications,
certificates, and integration with Guru.

This backend must be:
- Secure
- Session-based
- Scalable
- Guru-driven
- Production-grade

-------------------------------------------------
TECH STACK (FIXED)
-------------------------------------------------
- Node.js + Express + TypeScript
- PostgreSQL (Neon / Replit)
- Drizzle ORM
- Session-based auth (HTTP-only cookies)
- Razorpay integration
- OpenAI (via backend only)
- Zod validation
- Rate limiting
- Centralized error handling

-------------------------------------------------
ARCHITECTURE (MANDATORY)
-------------------------------------------------

Shishya Frontend
   ‚Üì (session cookie)
Shishya Backend (THIS SYSTEM)
   ‚Üì (X-API-Key)
Guru Public APIs

Rules:
- Frontend NEVER calls Guru directly
- Backend acts as proxy, validator, and executor
- Backend enriches requests with user context
- Backend caches Guru responses safely

-------------------------------------------------
API STRUCTURE (MANDATORY)
-------------------------------------------------

/api
 ‚îú‚îÄ‚îÄ auth
 ‚îú‚îÄ‚îÄ user
 ‚îú‚îÄ‚îÄ wallet
 ‚îú‚îÄ‚îÄ payments
 ‚îú‚îÄ‚îÄ courses
 ‚îú‚îÄ‚îÄ learning
 ‚îú‚îÄ‚îÄ labs
 ‚îú‚îÄ‚îÄ tests
 ‚îú‚îÄ‚îÄ projects
 ‚îú‚îÄ‚îÄ certificates
 ‚îú‚îÄ‚îÄ marksheet
 ‚îú‚îÄ‚îÄ mithra
 ‚îú‚îÄ‚îÄ notifications
 ‚îú‚îÄ‚îÄ portfolio
 ‚îî‚îÄ‚îÄ health

-------------------------------------------------
1Ô∏è‚É£ AUTHENTICATION & SESSIONS
-------------------------------------------------

POST   /api/auth/signup
POST   /api/auth/verify-otp
POST   /api/auth/login
POST   /api/auth/logout
GET    /api/auth/me
POST   /api/auth/resend-otp

Identities:
- Email + password
- OTP email verification
- Session stored in DB
- Secure cookies only

-------------------------------------------------
2Ô∏è‚É£ USER PROFILE & ACCOUNT
-------------------------------------------------

GET    /api/user/profile
PATCH  /api/user/profile

GET    /api/user/subscription
GET    /api/user/features

-------------------------------------------------
3Ô∏è‚É£ WALLET & CREDITS (EXECUTION ONLY)
-------------------------------------------------

GET    /api/wallet/balance
GET    /api/wallet/transactions

POST   /api/wallet/deduct
POST   /api/wallet/add    // system-only (webhooks, admin sync)

POST   /api/wallet/voucher/redeem

Rules:
- Cannot go negative
- All changes logged
- Pricing fetched from Guru

-------------------------------------------------
4Ô∏è‚É£ PAYMENTS (RAZORPAY)
-------------------------------------------------

POST   /api/payments/create-order
POST   /api/payments/verify
POST   /api/payments/webhook   // no auth

Responsibilities:
- Verify signatures
- Credit wallet
- Sync subscription status
- Notify user

-------------------------------------------------
5Ô∏è‚É£ COURSE CATALOG (PROXY FROM GURU)
-------------------------------------------------

GET    /api/courses
GET    /api/courses/:id

Rules:
- Fetch from Guru public APIs
- Cache responses
- Only published courses visible

-------------------------------------------------
6Ô∏è‚É£ ENROLLMENT & LEARNING FLOW
-------------------------------------------------

POST   /api/courses/:id/enroll
GET    /api/courses/:id/progress

-------------------------------------------------
7Ô∏è‚É£ LESSON EXECUTION
-------------------------------------------------

GET    /api/learning/lesson/:lessonId
POST   /api/learning/lesson/:lessonId/complete

-------------------------------------------------
8Ô∏è‚É£ PRACTICE LABS
-------------------------------------------------

GET    /api/labs/:courseId
GET    /api/labs/:courseId/:labId
POST   /api/labs/:courseId/:labId/submit

Rules:
- Validation in backend
- Unlock rules enforced
- Credit deduction enforced

-------------------------------------------------
9Ô∏è‚É£ TESTS & ASSESSMENTS
-------------------------------------------------

GET    /api/tests/:courseId
GET    /api/tests/:courseId/:testId
POST   /api/tests/:courseId/:testId/start
POST   /api/tests/:courseId/:testId/submit

Rules:
- One-attempt enforcement
- Timer server-validated
- Mithra disabled during attempt

-------------------------------------------------
üîü PROJECT SUBMISSIONS
-------------------------------------------------

GET    /api/projects/:courseId
POST   /api/projects/:courseId/:projectId/submit

-------------------------------------------------
1Ô∏è‚É£1Ô∏è‚É£ CERTIFICATES
-------------------------------------------------

GET    /api/certificates
POST   /api/certificates/generate
GET    /api/certificates/:id
GET    /api/verify/certificate/:id   // public

Rules:
- Eligibility fetched from Guru
- Credit deduction enforced

-------------------------------------------------
1Ô∏è‚É£2Ô∏è‚É£ MARKSHEET
-------------------------------------------------

GET    /api/marksheet
GET    /api/verify/marksheet/:id   // public

-------------------------------------------------
1Ô∏è‚É£3Ô∏è‚É£ AI TUTOR ‚Äî MITHRA
-------------------------------------------------

POST   /api/mithra/ask

Rules:
- Backend-only OpenAI calls
- Credit deduction per query
- Context from Guru
- Disabled during active tests

-------------------------------------------------
1Ô∏è‚É£4Ô∏è‚É£ NOTIFICATIONS
-------------------------------------------------

GET    /api/notifications
POST   /api/notifications/:id/read
POST   /api/notifications/read-all

-------------------------------------------------
1Ô∏è‚É£5Ô∏è‚É£ PORTFOLIO (PUBLIC PROFILE)
-------------------------------------------------

GET    /api/portfolio/me
GET    /api/portfolio/:username

-------------------------------------------------
1Ô∏è‚É£6Ô∏è‚É£ SYSTEM & HEALTH
-------------------------------------------------

GET    /api/health

-------------------------------------------------
SECURITY RULES (MANDATORY)
-------------------------------------------------
- Session-based auth everywhere
- Rate limiting (AI, tests, payments)
- No secrets in frontend
- No pricing logic here
- All rules validated against Guru
- Idempotent payment handling
- Centralized error handler

-------------------------------------------------
INTEGRATION WITH GURU
-------------------------------------------------

- Use X-API-Key
- Base URL from ENV
- Safe retries
- Graceful fallback
- Cache TTL per endpoint

-------------------------------------------------
OUTPUT EXPECTATION
-------------------------------------------------
Generate:
1) Express route files (modular)
2) Controllers & services
3) Session middleware
4) Drizzle schema
5) Validation schemas
6) Payment & webhook logic
7) Guru proxy layer
8) API documentation
9) README explaining Guru ‚Üî Shishya boundary

Think like a platform integrator.
Respect authority boundaries.
Enforce rules strictly.
Deliver production-ready backend code.
